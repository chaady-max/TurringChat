<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Turring Test — Dev Client</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    #log { border: 1px solid #ddd; padding: 10px; height: 300px; overflow-y: auto; white-space: pre-wrap; background: #fafafa; }
    .row { margin-top: 10px; display: flex; gap: 8px; }
    button { padding: 8px 12px; }
    input[type="text"] { flex: 1; padding: 8px; }
    .stats { margin-top: 10px; font-size: 14px; color: #444; display: flex; gap: 8px; flex-wrap: wrap; }
    .badge { display: inline-block; padding: 4px 8px; border: 1px solid #ccc; border-radius: 6px; background: #fff; }

    /* small panels */
    .panel { margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; padding: 10px; max-width: 360px; }
    .panel h3 { margin: 0 0 6px 0; font-size: 15px; color: #333; }
    .panel .kv { display: flex; justify-content: space-between; margin-top: 4px; font-size: 14px; }

    /* timer colors */
    .timer-green  { background: #e6f6ea; border-color: #8ad1a3; color: #1f6b3a; }
    .timer-orange { background: #fff1e0; border-color: #f3b46a; color: #8a4b00; }
    .timer-red    { background: #ffe7e7; border-color: #f08f90; color: #8a1c1d; }

    .disabled { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>
  <h1>Turring Test — Dev Client</h1>

  <div class="stats">
    <span class="badge">Round left: <span id="roundLeft">—</span>s</span>
    <span id="turnBadge" class="badge">Turn left: <span id="turnLeft">—</span>s</span>
    <span class="badge">Turn: <span id="turn">—</span></span>
    <span class="badge">Commit: <code id="commitHash">—</code></span>
    <span class="badge">Pool: <span id="poolCount">0</span></span>
    <span class="badge">Version: <span id="appVersion">—</span></span>
  </div>

  <!-- Session box -->
  <div class="panel" id="sessionBox">
    <h3>Session</h3>
    <div class="kv"><span>Games played</span><strong id="sessGames">0</strong></div>
    <div class="kv"><span>Credits</span><strong id="sessCredits">0</strong></div>
  </div>

  <!-- Pool box -->
  <div class="panel" id="poolBox">
    <h3>Matchmaking Pool</h3>
    <div class="kv"><span>Status</span><strong id="poolStatus">Not in pool</strong></div>
    <div class="kv"><span>People in pool</span><strong id="poolCountText">0</strong></div>
    <div class="row">
      <button id="joinPoolBtn">Get me in the pool</button>
      <button id="leavePoolBtn" class="disabled">Leave pool</button>
    </div>
    <small style="color:#666;display:block;margin-top:6px">Join first to unlock Start Match. Each browser tab counts as one human.</small>
  </div>

  <div id="typing" class="stats" style="min-height:22px;color:#666"></div>
  <div id="log"></div>

  <div class="row">
    <input id="msg" type="text" placeholder="Type message… (Enter to send)" />
    <button id="send">Send</button>
  </div>

  <div class="row">
    <button id="guessHuman">Guess HUMAN</button>
    <button id="guessAI">Guess AI</button>
    <button id="start" class="disabled" style="margin-left:auto;">Start Match</button>
    <button id="state">Get State</button>
  </div>

<script>
let ws = null;
const logEl = document.getElementById('log');
const roundLeftEl = document.getElementById('roundLeft');
const turnLeftEl  = document.getElementById('turnLeft');
const turnEl      = document.getElementById('turn');
const commitEl    = document.getElementById('commitHash');
const typingEl    = document.getElementById('typing');
const msgEl       = document.getElementById('msg');
const sendBtn     = document.getElementById('send');
const turnBadge   = document.getElementById('turnBadge');

// pool + session UI
const poolCountEl = document.getElementById('poolCount');
const poolCountText = document.getElementById('poolCountText');
const poolStatusEl = document.getElementById('poolStatus');
const joinPoolBtn = document.getElementById('joinPoolBtn');
const leavePoolBtn = document.getElementById('leavePoolBtn');
const startBtn = document.getElementById('start');
const appVersionEl = document.getElementById('appVersion');

const sessGamesEl   = document.getElementById('sessGames');
const sessCreditsEl = document.getElementById('sessCredits');

let sessGames   = Number(sessionStorage.getItem('sessGames') || 0);
let sessCredits = Number(sessionStorage.getItem('sessCredits') || 0);
function updateSessionUI() {
  sessGamesEl.textContent = String(sessGames);
  sessCreditsEl.textContent = String(sessCredits);
}
updateSessionUI();

// token for pool membership
let myToken = sessionStorage.getItem('poolToken') || null;

// default; overwritten by server
let MAX_TURN_SECONDS = 30;

function log(line) {
  const atBottom = logEl.scrollTop + logEl.clientHeight >= logEl.scrollHeight - 5;
  logEl.textContent += line + "\n";
  if (atBottom) logEl.scrollTop = logEl.scrollHeight;
}

function setTurnColor(secLeft) {
  turnBadge.classList.remove('timer-green','timer-orange','timer-red');
  const redThreshold    = Math.max(0, MAX_TURN_SECONDS - 10);
  const orangeThreshold = Math.max(0, MAX_TURN_SECONDS - 20);
  if (secLeft > redThreshold) {
    turnBadge.classList.add('timer-green');
  } else if (secLeft > orangeThreshold) {
    turnBadge.classList.add('timer-orange');
  } else {
    turnBadge.classList.add('timer-red');
  }
}

async function fetchPoolCount() {
  try {
    const r = await fetch('/pool/count');
    const j = await r.json();
    poolCountEl.textContent = j.count;
    poolCountText.textContent = j.count;
  } catch {}
}

// pool join/leave
joinPoolBtn.onclick = async () => {
  try {
    const r = await fetch('/pool/join', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token: myToken})});
    const j = await r.json();
    if (j.ok) {
      myToken = j.token;
      sessionStorage.setItem('poolToken', myToken);
      poolStatusEl.textContent = 'In pool';
      joinPoolBtn.classList.add('disabled');
      leavePoolBtn.classList.remove('disabled');
      startBtn.classList.remove('disabled');
      await fetchPoolCount();
      log('Joined pool.');
    }
  } catch (e) {
    log('Pool join failed: ' + e);
  }
};

leavePoolBtn.onclick = async () => {
  try {
    await fetch('/pool/leave', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token: myToken})});
  } catch {}
  poolStatusEl.textContent = 'Not in pool';
  leavePoolBtn.classList.add('disabled');
  joinPoolBtn.classList.remove('disabled');
  // Do not disable Start; but generally you should join again before starting
  startBtn.classList.add('disabled');
  fetchPoolCount();
  log('Left pool.');
};

// poll pool count
setInterval(fetchPoolCount, 2000);
fetchPoolCount();

// leave pool on unload
window.addEventListener('beforeunload', () => {
  if (myToken) {
    navigator.sendBeacon('/pool/leave', JSON.stringify({token: myToken}));
  }
});

// Start match: opens ws with token; server removes us from pool automatically
startBtn.onclick = () => {
  if (startBtn.classList.contains('disabled')) return;
  if (ws) { try { ws.close(); } catch(e){} }
  const qs = myToken ? ('?token=' + encodeURIComponent(myToken)) : '';
  ws = new WebSocket(`ws://${location.host}/ws/match${qs}`);
  ws.onopen = () => log('WS connected');
  ws.onclose = () => { log('WS closed'); typingEl.textContent=''; };
  ws.onmessage = ev => {
    try {
      const data = JSON.parse(ev.data);

      if (data.type === 'match_start') {
        // take max turn seconds from server (keeps UI in sync with backend)
        if (typeof data.turn_seconds === 'number') MAX_TURN_SECONDS = data.turn_seconds;
        if (data.commit_hash) commitEl.textContent = data.commit_hash;
        if (data.version) appVersionEl.textContent = data.version;
        log(`Match started. Opponent hidden. You are A. (${data.round_seconds}s round / ${MAX_TURN_SECONDS}s turn)`);
        setTurnColor(MAX_TURN_SECONDS);
        turnLeftEl.textContent = MAX_TURN_SECONDS;
        poolStatusEl.textContent = 'In match';
      }

      if (data.type === 'tick') {
        roundLeftEl.textContent = data.round_left;
        turnLeftEl.textContent  = data.turn_left;
        turnEl.textContent      = data.turn;
        setTurnColor(Number(data.turn_left || 0));
      }

      if (data.type === 'typing') {
        typingEl.textContent = data.on ? 'B is typing…' : '';
      }

      if (data.type === 'chat') {
        log(`${data.from_}: ${data.text}`);
      }

      if (data.type === 'end') {
        const delta = Number(data.score_delta || 0);
        sessGames += 1;
        sessCredits += delta;
        sessionStorage.setItem('sessGames', String(sessGames));
        sessionStorage.setItem('sessCredits', String(sessCredits));
        updateSessionUI();

        log(`GAME END — reason=${data.reason} score_delta=${delta}`);
        if (data.reveal) {
          log(`REVEAL: opponent=${data.reveal.opponent_type} nonce=${data.reveal.nonce} ts=${data.reveal.commit_ts}`);
          if (commitEl.textContent && data.reveal.commit_ts) {
            log(`Verify: sha256(opponent|nonce|ts) == commit (${commitEl.textContent})`);
          }
        }
        typingEl.textContent = '';
        poolStatusEl.textContent = 'Not in pool';
        leavePoolBtn.classList.add('disabled');
        joinPoolBtn.classList.remove('disabled');
        startBtn.classList.add('disabled');
        fetchPoolCount();
      }

      if (data.type === 'state') {
        log(`STATE: opponent(hidden) round_left=${data.round_left} turn_left=${data.turn_left} turn=${data.turn}`);
        setTurnColor(Number(data.turn_left || 0));
      }
    } catch (e) {
      log('parse error: ' + e);
    }
  };
};

// click to send
document.getElementById('send').onclick = () => {
  if (!ws) return;
  const v = msgEl.value.trim();
  if (!v) return;
  ws.send(JSON.stringify({type: 'chat', text: v}));
  log(`A: ${v}`);
  msgEl.value = '';
  msgEl.focus();
};

// ENTER to send
msgEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('send').click();
  }
});

document.getElementById('guessHuman').onclick = () => {
  if (!ws) return;
  ws.send(JSON.stringify({type: 'guess', guess: 'HUMAN'}));
};

document.getElementById('guessAI').onclick = () => {
  if (!ws) return;
  ws.send(JSON.stringify({type: 'guess', guess: 'AI'}));
};

document.getElementById('state').onclick = () => {
  if (!ws) return;
  ws.send(JSON.stringify({type: 'state'}));
};
</script>
</body>
</html>
